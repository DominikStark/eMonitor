<script>
    $(document).ready(function() {
        var innerLayout = $('#alarmcontainer').layout({
            center:{paneSelector: "#alarmssubcenter",onresize: $.layout.callbacks.resizePaneAccordions},
            north: {paneSelector: "#alarmssubnorth", size: 40, slidable: false, resizable: false, closable:false, spacing_open: 0},
            resizerTip:'{{ _('layout.resize') }}',
            togglerTip_open: '{{ _('layout.open') }}',
            togglerTip_closed: '{{ _('layout.closed') }}'
        });

        $("#alarmaccordion").accordion({ heightStyle: "fill", active: {{ activeacc }}});
        $("#alarmaccordion h3").eq($('#alarmaccordion').accordion( "option", "active" )).click();

        $('.options').hover(function() {
            $(this).find('.dropdown-menu').stop(true, true).delay(200).fadeIn(500);
            }, function() {
                $(this).find('.dropdown-menu').stop(true, true).delay(200).fadeOut(500);
        });
    });

    ws.onmessage=function(e){
        $('#ws').html('<i class="fa fa-eye fa-lg"></i>');
        if(e.data=='alarm.updated'){
            refreshAlarms();
        }else if(e.data=='alarm.added'){
            alert('{{ _('alarm.addedalert') }}');
            refreshAlarms();
        }
    }
</script>

<style>
    #alarmssubnorth {padding:0 10px 0 10px;background-color: #dedede;border-width:0 0 1px 0;}
    #alarmssubcenter {border-width:0;padding:0;}

    h3 {font-size: 1.1em; background: #ababab; border: 1px 1px solid black!important;margin:0;cursor:pointer;padding:10px 0 10px 10px;overflow:hidden;position:relative;z-index:0;}
    .alarmrow {position:relative;clear:left;padding:4px 2px 0 15px;border-bottom:1px solid silver;background-color:#fff;-webkit-user-select: none;-khtml-user-select: none;-moz-user-select: none;-ms-user-select: none;user-select: none;}
    .alarmrow a{color:#818181;}
    .alarmrow a:hover{color:#b40431;}
    .btn {padding:2px!important;background-color:transparent!important;color:#b40431;border-width:0;}
    .btn:hover {color:#428bca;}

    .alarmrow:hover {background-color: #dedede;cursor:pointer;}
    .prio {position:absolute; top:0; left:2px; bottom:0; width:5px;}
    .prio0 {background-color:green!important;}
    .prio1 {background-color:orange!important;}
    .prio2 {background-color:red!important;}

    .alarmrow .address {float:left; width:100%;font-weight:bold;margin-top:4px;}
    .alarmrow .alarmdetails{position:absolute;top:4px;right:30px;color:#818181 !important}
    .alarmrow .alarmdetails i{margin-right:3px;}
    .mapimage {position:absolute;right:60px;top:10px;display:none;}
    .addalarm {position:absolute;right:5px;top:5px;}
    .maphidden {visibility:hidden!important;}


    .dropdown button {background-color:transparent;cursor:pointer;padding:1px;margin:0;border-width:0;}
</style>

<div style="height:100%;width:100%;padding:0;margin:0;" id="alarmcontainer" class="alarmcontainer">

    <div class="pane" id="alarmssubnorth" style="padding-top:5px;">
        <button type="button" name="action" value="addalarm" onclick="return addAlarm(0)" title="{{ _('alarms.addtitle') }}"><i class="fa fa-plus fa-lg"></i></button>
        <button type="button" name="action" value="activatealarm" title="{{ _('alarms.autorefresh') }}" onclick="return refreshAlarms()"><i class="fa fa-refresh fa-lg"></i></button>
        <button type="button" title="{{ _('alarms.archivetitle') }}"><i class="fa fa-shield fa-lg"></i></button>
    </div>

    <div id="alarmssubcenter">
        <div id="alarmaccordion">
            {% for k in alarmstates.keys() %}
            <h3 a_name="alarmstate__{{ k }}" class="btn-default" style="background-color:#adadad;padding-right:5px;border-bottom:1px solid #ddd;" onclick="return showMappoints({{ k }})" key="{{ k }}">
                {{ _('alarmstate.'+alarmstates[k]) }}
                <span class="badge badge-info pull-right">{{ stats[k] }}</span>
            </h3>

            <div id="alarmstate_{{ k }}" style="overflow-x:hidden!important;">
                {% for alarm in alarms %}
                {% if k==alarm.state|string %}
                <!--<div class="alarmrow" lat="{{ alarm.lat }}" lng="{{ alarm.lng }}" zoom="{{ alarm.zoom }}" priority="{{ alarm.priority }}" onclick="mapPanTo(this)" alarmid="{{ alarm.id }}" ondblclick="$('#editalarm_{{ alarm.id}}').click()">-->
                <div class="alarmrow" lat="{{ alarm.get('lat') }}" lng="{{ alarm.get('lng') }}" zoom="{{ alarm.get('zoom') }}" priority="{{ alarm.priority }}" onclick="mapPanTo(this)" alarmid="{{ alarm.id }}" ondblclick="return addAlarm({{ alarm.id }})">

                   <div style="overflow:hidden;">
                        <div class="prio prio{{ alarm.priority }}" title="{{ _('alarms.prio'+alarm.priority|string) }}"> </div>
                        <span class="date">{{ alarm.timestamp|datetime }}</span><br/>
                        <b class="key">{%  if alarm.key.category!='' %}{{ alarm.key.category }}: {% endif %}{{ alarm.key.key }}</b>
                        <br/>
                        <span class="address">
                            {{ alarm.city.name }}:
                            {{ alarm.street.name }}
                            {{ alarm.streetno }}
                            <em style="margin-left:10px;" class="address">{{ alarm.street2.name }}</em>
                            {% if alarm.object %}> {{ alarm.object.name }}{% endif %}
                        </span>
                        <div class="alarmdetails">
                            {% if alarm.type==1 %}<a href="/file/fax/{{ alarm.get('filename') }}" target="blank"><i class="fa fa-paperclip" title="{{ _('alarms.showfax') }}"></i></a>{% endif %}
                            <a href="#" onclick="return addMessage({{ alarm.id }})" title="{{ _('alarms.messagestitle', number=alarm.history|count) }}">{{ alarm.history|count }}<i class="fa fa-comment-o" style="padding-left:2px;"></i></a>
                            {% if alarm.type==1 %}<i class="fa fa-print" title="{{ _('alarms.typeautomatic') }}"></i>{% endif %}
                            {% if alarm.type==2 %}<i class="fa fa-user" title="{{ _('alarms.typemanual') }}"></i>{% endif %}
                            {% if alarm.get('lat', '0')!='' %}
                            <i class="fa fa-map-marker" title="{{ _('alarms.titlemap') }}"></i>
                            {% endif %}
                        </div>
                   </div>

                    <div class="btn-group options" style="position:absolute;top:2px;right:5px;">
                        <a class="btn btn-primary dropdown-toggle" data-toggle="dropdown" href="#">
                            <i class="fa fa-gear fa-lg"></i>
                        </a>
                        <ul class="dropdown-menu pull-right">
                            <li><a href="#" onclick="return addAlarm({{ alarm.id }})" id="editalarm_{{ alarm.id }}"><i class="fa fa-pencil fa-fw"></i> {{ _('alarm.edit') }}</a></li>

                            {% if alarm.state==1 %}
                            <li><a href="#" onclick="return questionFinish({{ alarm.id }})"><i class="fa fa-flag-checkered fa-fw"></i> {{ _('alarm.finish') }}</a></li>
                            {% endif %}
                            {% if alarm.state==0 or alarm.state==2 %}
                            <li><a href="#" onclick="return questionActivate({{ alarm.id }})"><i class="fa fa-bell fa-fw"></i> {{ _('alarm.activate') }}</a></li>
                            {% endif %}
                            {% if alarm.state==2 %}
                            <li><a href="#" onclick="return questionArchive({{ alarm.id }})"><i class="fa fa-shield fa-fw"></i> {{ _('alarm.archive') }}</a></li>
                            {% endif %}
                            <li><div><a href="#" onclick="return printAlarm({{ alarm.id }})"><i class="fa fa-print fa-fw"></i> {{ _('alarm.print') }}</a> <input type="text" name="printcount" style="width:20px;" value="1"/></div></li>

                        </ul>
                    </div>

                </div>
                {% endif %}
                {% endfor %}
            </div>
            {% endfor %}
        </div>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
            <div style="position:absolute;top:50%;width:80%;left:10%;">
            <div class="alert alert-info alert-dismissable" style="width:100%;">
                <button type="button" class="close" data-dismiss="alert" aria-hidden="true">&times;</button>
                {% for message in messages %}
                    <p>{{ message|safe }}</p>
                {% endfor %}
            </div>
            </div>
            {% endif %}
        {% endwith %}

    </div>
    {%  block footer %}
         <div style="clear:both;position:fixed;bottom:5px;right:30px;color:#fff">
        hier kommt der Footer
    </div>
    {% endblock %}

        <script>
            function refreshAlarms(){
                if($('#alarmaccordion').length>0){
                    var active = $('#alarmaccordion').accordion( "option", "active" );
                    var formoptions = {
                        target:        '#editForm_{{ frontendarea }}',
                        url:           '/alarms?action=refresh&area={{ frontendarea }}&activeacc='+active
                    };
                    $('#editForm_{{ frontendarea }}').ajaxSubmit(formoptions);

                    return false;
                }
                return false;
            }

            function addMessage(alarmid){
                $.ajax({ type : "POST", url : "/data/alarms?action=message&alarmid="+alarmid,
                    success: function(result) {
                        $('#overlaycontent').html(result);
                        $('.overlay').toggle();
                        return false;
                    }
                });
                return false;
            }

            function questionFinish(alarmid){
                if (confirm('{{ _('alarms.finishquestion') }}')){
                    $.ajax({ type : "POST", url : "/alarms?action=finishalarm&alarmid="+alarmid+"&area={{ frontendarea }}",
                        success: function(result) {
                            $('#editForm_{{ frontendarea }}').html(result);
                            return false;
                        }
                    });
                }
                return false;
            }

            function questionActivate(alarmid){
                console.log('activate');
                if (confirm('{{ _('alarms.activatequestion') }}')){

                    $.ajax({ type : "POST", url : "/alarms?action=activatealarm&alarmid="+alarmid+"&area={{ frontendarea }}",
                        success: function(result) {
                            $('#editForm_{{ frontendarea }}').html(result);
                            return false;
                        }
                    });
                }
                return false;
            }

            function questionActivate_old(alarmid){
                if (confirm('{{ _('alarms.activatequestion') }}')){
                    $.ajax({ type : "POST", url : "/alarms?action=activatealarm&alarmid="+alarmid+"&area={{ frontendarea }}",
                        success: function(result) {
                            $('#editForm_{{ frontendarea }}').html(result);
                            return false;
                        }
                    });
                }
                return false;
            }


            function questionArchive(alarmid){
                if (confirm('{{ _('alarms.archivequestion') }}')){
                    var formoptions = {
                        target:        '#editForm_{{ frontendarea }}',
                        url:           '/alarms?action=archivealarm&alarmid='+alarmid+'&area={{ frontendarea }}',
                    };
                    $('#editForm_{{ frontendarea }}').ajaxSubmit(formoptions);
                    return false;
                }
                return false;
            }

            function sendtomonitor(id){
                $.ajax({ type : "POST", url : "/data/alarms?action=alarmmonitor&alarmid="+id,
                     success: function(ret) {
                        /* */
                    }
                });
                return false;
            }


            function printAlarm(id){
                 $.ajax({ type : "POST", url : "/data/alarms?action=printalarm&alarmid="+id,
                    success: function(ret) {
                        return false;
                    }
                });
                return false;
            }

            function addAlarm(id){
                $.ajax({ type : "POST", url : "/data/alarms?action=editalarm&alarmid="+id+"&frontendarea={{ frontendarea }}",
                     success: function(ret) {
                        $('#alarmssubcenter').html(ret);
                        return false;
                    }
                });
                return false;

            }

            var alarmHouses = L.layerGroup();
            function mapPanTo(obj){
                parent.setPosition($(obj).attr('lat'), $(obj).attr('lng'));
                $.ajax({ type : "POST", url : "/data/alarms?action=housecoordinates&alarmid="+$(obj).attr('alarmid')+"&format=json",
                     success: function(ret) {
                        alarmHouses.clearLayers();
                        if (ret.lat){
                            var polygonPoints = [];
                            $.each(ret.lat, function(index, element) {
                                polygonPoints.push(new L.LatLng(ret.lat[index], ret.lng[index]));
                            });
                            alarmHouses.addLayer(new L.Polygon(polygonPoints));
                            alarmHouses.addTo(map);
                            parent.setPosition(ret.lat[0], ret.lng[0]);
                        }else{

                        }
                        return false;
                    }
                });

            }

            function showMappoints(state){
                alarmMarkers.clearLayers();
                alarmHouses.clearLayers();
                //$('.mapimage').hide();
                //$('#image_'+state).show();
                $('#alarmstate_'+state).children().each(function(i){
                    var m = new parent.L.Marker(new parent.L.LatLng($(this).attr('lat'), $(this).attr('lng')), {icon:parent.colorcode[$(this).attr('priority')],draggable:false});
                    parent.alarmMarkers.addLayer(m);
                    //console.log($(this).find('.prio').prop('outerHTML'));
                    m.bindPopup('<small>'+$(this).find('.date').html()+'</small><br/>'+$(this).find('.key').html()+'<br/><b>'+$(this).find('.address').html()+'</b>');
                    m.options['alarmid'] = $(this).attr('alarmid');
                    m.on('click', onAlarmMarkerClick);
                    m.on('mouseover', onAlarmMarkerMouseOver);
                    m.on('mouseout', onAlarmMarkerMouseOut);
                });
                return false;
            }

            function onAlarmMarkerMouseOver(e){
                this.openPopup();
            }

            function onAlarmMarkerMouseOut(e){
                this.closePopup();
            }

            function onAlarmMarkerClick(e){
                $('#editalarm_'+this.options['alarmid']).click();
            }

        </script>
</div>
